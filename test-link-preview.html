<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¾æ¥é¢„è§ˆ API æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
            background: #f5f5f5;
        }

        h1 { font-size: 20px; margin-bottom: 4px; }
        .subtitle { color: #666; font-size: 13px; margin-bottom: 24px; }

        /* è¾“å…¥åŒºåŸŸ */
        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            font-family: monospace;
        }

        button {
            padding: 10px 20px;
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        button:hover { background: #005bb5; }
        button:disabled { background: #aaa; cursor: not-allowed; }

        /* API é€‰æ‹© */
        .api-selector {
            margin-bottom: 16px;
            font-size: 13px;
        }

        .api-selector label {
            margin-right: 16px;
            cursor: pointer;
        }

        /* çŠ¶æ€åŒºåŸŸ */
        #status {
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }

        #status.loading { background: #fff3cd; border: 1px solid #ffc107; color: #856404; }
        #status.success { background: #d4edda; border: 1px solid #28a745; color: #155724; }
        #status.error   { background: #f8d7da; border: 1px solid #dc3545; color: #721c24; }

        /* é¢„è§ˆå¡ç‰‡ */
        #previewCard {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .preview-favicon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: contain;
            background: #f0f0f0;
        }

        .preview-favicon-fallback {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background: #0071e3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .preview-domain {
            font-size: 12px;
            color: #666;
        }

        .preview-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .preview-description {
            font-size: 13px;
            color: #555;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .preview-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        /* åŸå§‹ JSON æ•°æ® */
        #rawJson {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre;
            display: none;
            margin-bottom: 16px;
        }

        .toggle-json {
            font-size: 12px;
            color: #0071e3;
            cursor: pointer;
            text-decoration: underline;
            background: none;
            border: none;
            padding: 0;
            margin-bottom: 8px;
            display: none;
        }

        /* æµ‹è¯•ç”¨ä¾‹ */
        .test-urls {
            margin-bottom: 16px;
            font-size: 13px;
        }

        .test-urls strong { display: block; margin-bottom: 6px; }

        .test-url-btn {
            display: inline-block;
            padding: 4px 10px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            margin: 3px;
            color: #333;
            font-family: monospace;
        }

        .test-url-btn:hover { background: #dee2e6; }

        /* è¯·æ±‚ä¿¡æ¯ */
        .request-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            display: none;
        }

        hr { border: none; border-top: 1px solid #ddd; margin: 20px 0; }
    </style>
</head>
<body>

    <h1>ğŸ” é“¾æ¥é¢„è§ˆ API æµ‹è¯•å·¥å…·</h1>
    <p class="subtitle">ç”¨äºéªŒè¯ API å¯ç”¨æ€§ã€CORS é—®é¢˜å’Œè¿”å›æ•°æ®ç»“æ„</p>

    <!-- å¿«é€Ÿæµ‹è¯• URL -->
    <div class="test-urls">
        <strong>å¿«é€Ÿæµ‹è¯• URLï¼ˆç‚¹å‡»å¡«å…¥ï¼‰ï¼š</strong>
        <span class="test-url-btn" onclick="fillUrl('https://github.com')">github.com</span>
        <span class="test-url-btn" onclick="fillUrl('https://www.zhihu.com')">zhihu.com</span>
        <span class="test-url-btn" onclick="fillUrl('https://juejin.cn')">juejin.cn</span>
        <span class="test-url-btn" onclick="fillUrl('https://developer.mozilla.org')">MDN</span>
        <span class="test-url-btn" onclick="fillUrl('https://www.youtube.com')">youtube.com</span>
        <span class="test-url-btn" onclick="fillUrl('https://openai.com')">openai.com</span>
    </div>

    <!-- API é€‰æ‹© -->
    <div class="api-selector">
        <strong>é€‰æ‹© APIï¼š</strong><br><br>
        <label>
            <input type="radio" name="api" value="microlink" checked>
            microlink.ioï¼ˆæ— éœ€ Keyï¼Œ50æ¬¡/å¤©ï¼‰
        </label>
        <label>
            <input type="radio" name="api" value="jsonlink">
            jsonlink.ioï¼ˆéœ€è¦ Keyï¼Œ1000æ¬¡/æœˆï¼‰
        </label>
        <label>
            <input type="radio" name="api" value="favicon_only">
            ä»… Faviconï¼ˆGoogleï¼Œæ— é™åˆ¶ï¼‰
        </label>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-row">
        <input type="text" id="urlInput" placeholder="è¾“å…¥è¦é¢„è§ˆçš„ URLï¼Œå¦‚ https://github.com" value="https://github.com">
        <button id="fetchBtn" onclick="fetchPreview()">è·å–é¢„è§ˆ</button>
    </div>

    <!-- è¯·æ±‚ä¿¡æ¯ -->
    <div class="request-info" id="requestInfo"></div>

    <!-- çŠ¶æ€ -->
    <div id="status"></div>

    <!-- é¢„è§ˆå¡ç‰‡ -->
    <div id="previewCard">
        <div class="preview-header">
            <img class="preview-favicon" id="previewFavicon" src="" alt="favicon" onerror="this.style.display='none'; document.getElementById('faviconFallback').style.display='flex'">
            <div class="preview-favicon-fallback" id="faviconFallback" style="display:none">?</div>
            <div class="preview-domain" id="previewDomain"></div>
        </div>
        <div class="preview-title" id="previewTitle"></div>
        <div class="preview-description" id="previewDescription"></div>
        <img class="preview-image" id="previewImage" src="" alt="preview" style="display:none" onerror="this.style.display='none'">
    </div>

    <!-- JSON åŸå§‹æ•°æ® -->
    <button class="toggle-json" id="toggleJsonBtn" onclick="toggleJson()">â–¶ æŸ¥çœ‹åŸå§‹ JSON æ•°æ®</button>
    <pre id="rawJson"></pre>

    <hr>

    <!-- è¯´æ˜ -->
    <div style="font-size: 12px; color: #666; line-height: 1.8;">
        <strong>æµ‹è¯•ç›®çš„ï¼š</strong><br>
        âœ… éªŒè¯ API æ˜¯å¦å¯ç”¨ï¼ˆCORS æ˜¯å¦é€šè¿‡ï¼‰<br>
        âœ… æŸ¥çœ‹è¿”å›çš„æ•°æ®ç»“æ„<br>
        âœ… æµ‹è¯•ä¸åŒç½‘ç«™çš„é¢„è§ˆæ•ˆæœ<br>
        âœ… è¯„ä¼°å“åº”é€Ÿåº¦<br>
        <br>
        <strong>æ³¨æ„äº‹é¡¹ï¼š</strong><br>
        â€¢ microlink.io å…è´¹ç‰ˆé™åˆ¶ 50æ¬¡/å¤©ï¼Œè¶…å‡ºåè¿”å› 429<br>
        â€¢ éƒ¨åˆ†ç½‘ç«™ï¼ˆå¦‚å¾®ä¿¡ï¼‰ä¼šå±è”½çˆ¬è™«ï¼Œè¿”å›æ•°æ®å¯èƒ½ä¸ºç©º<br>
        â€¢ å›¾ç‰‡å¯èƒ½å› é˜²ç›—é“¾æ— æ³•æ˜¾ç¤º<br>
        â€¢ æ‰“å¼€ F12 æ§åˆ¶å°å¯æŸ¥çœ‹è¯¦ç»†ç½‘ç»œè¯·æ±‚
    </div>

    <script>
        // ==========================================
        // å¡«å…¥æµ‹è¯• URL
        // ==========================================
        function fillUrl(url) {
            document.getElementById('urlInput').value = url;
        }

        // ==========================================
        // è·å–é€‰ä¸­çš„ API
        // ==========================================
        function getSelectedApi() {
            return document.querySelector('input[name="api"]:checked').value;
        }

        // ==========================================
        // æ˜¾ç¤ºçŠ¶æ€
        // ==========================================
        function showStatus(type, msg) {
            const el = document.getElementById('status');
            el.className = type;
            el.textContent = msg;
            el.style.display = 'block';
        }

        // ==========================================
        // æ˜¾ç¤º/éšè— JSON
        // ==========================================
        function toggleJson() {
            const raw = document.getElementById('rawJson');
            const btn = document.getElementById('toggleJsonBtn');
            if (raw.style.display === 'none') {
                raw.style.display = 'block';
                btn.textContent = 'â–¼ éšè—åŸå§‹ JSON æ•°æ®';
            } else {
                raw.style.display = 'none';
                btn.textContent = 'â–¶ æŸ¥çœ‹åŸå§‹ JSON æ•°æ®';
            }
        }

        // ==========================================
        // ä¸»å‡½æ•°ï¼šè·å–é¢„è§ˆ
        // ==========================================
        async function fetchPreview() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();

            if (!url) {
                showStatus('error', 'âŒ è¯·è¾“å…¥ URL');
                return;
            }

            // ç®€å• URL æ ¼å¼æ ¡éªŒ
            let targetUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                targetUrl = 'https://' + url;
                urlInput.value = targetUrl;
            }

            const api = getSelectedApi();
            const btn = document.getElementById('fetchBtn');
            const startTime = Date.now();

            // é‡ç½® UI
            btn.disabled = true;
            btn.textContent = 'è¯·æ±‚ä¸­...';
            document.getElementById('previewCard').style.display = 'none';
            document.getElementById('rawJson').style.display = 'none';
            document.getElementById('toggleJsonBtn').style.display = 'none';
            document.getElementById('requestInfo').style.display = 'none';

            showStatus('loading', 'â³ æ­£åœ¨è¯·æ±‚ APIï¼Œè¯·ç¨å€™...');

            try {
                let data = null;
                let apiUrl = '';

                if (api === 'microlink') {
                    // ---- microlink.io ----
                    apiUrl = `https://api.microlink.io/?url=${encodeURIComponent(targetUrl)}`;
                    showRequestInfo('GET', apiUrl);

                    const res = await fetch(apiUrl);
                    const json = await res.json();
                    const elapsed = Date.now() - startTime;

                    // æ˜¾ç¤ºåŸå§‹ JSON
                    showRawJson(json);

                    if (json.status === 'success' && json.data) {
                        data = {
                            title: json.data.title || '',
                            description: json.data.description || '',
                            image: json.data.image ? json.data.image.url : '',
                            favicon: json.data.logo ? json.data.logo.url : getFavicon(targetUrl),
                            domain: new URL(targetUrl).hostname,
                        };
                        showStatus('success', `âœ… æˆåŠŸï¼è€—æ—¶ ${elapsed}ms | API: microlink.io | çŠ¶æ€: ${json.status}`);
                    } else {
                        showStatus('error', `âš ï¸ API è¿”å›å¼‚å¸¸ï¼š${json.status || 'æœªçŸ¥'} | è€—æ—¶ ${elapsed}ms`);
                        btn.disabled = false;
                        btn.textContent = 'è·å–é¢„è§ˆ';
                        return;
                    }

                } else if (api === 'jsonlink') {
                    // ---- jsonlink.ioï¼ˆéœ€è¦ Keyï¼Œè¿™é‡Œæ¼”ç¤ºè¯·æ±‚ç»“æ„ï¼‰----
                    // æ³¨æ„ï¼šæ²¡æœ‰ Key ä¼šè¿”å› 401ï¼Œè¿™é‡Œä»…æ¼”ç¤ºè¯·æ±‚æ ¼å¼
                    const API_KEY = 'YOUR_API_KEY_HERE'; // æ›¿æ¢ä¸ºä½ çš„ Key
                    apiUrl = `https://jsonlink.io/api/extract?url=${encodeURIComponent(targetUrl)}&api_key=${API_KEY}`;
                    showRequestInfo('GET', apiUrl.replace(API_KEY, '***KEY***'));

                    const res = await fetch(apiUrl);
                    const json = await res.json();
                    const elapsed = Date.now() - startTime;

                    showRawJson(json);

                    if (res.ok && json.title) {
                        data = {
                            title: json.title || '',
                            description: json.description || '',
                            image: json.images && json.images[0] ? json.images[0] : '',
                            favicon: json.favicon || getFavicon(targetUrl),
                            domain: new URL(targetUrl).hostname,
                        };
                        showStatus('success', `âœ… æˆåŠŸï¼è€—æ—¶ ${elapsed}ms | API: jsonlink.io`);
                    } else {
                        showStatus('error', `âš ï¸ jsonlink.io è¿”å›é”™è¯¯ï¼ˆå¯èƒ½éœ€è¦æœ‰æ•ˆçš„ API Keyï¼‰| è€—æ—¶ ${elapsed}ms`);
                        btn.disabled = false;
                        btn.textContent = 'è·å–é¢„è§ˆ';
                        return;
                    }

                } else if (api === 'favicon_only') {
                    // ---- ä»… Faviconï¼ˆGoogle S2 æœåŠ¡ï¼‰----
                    const domain = new URL(targetUrl).hostname;
                    apiUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                    showRequestInfo('GET (img)', apiUrl);

                    const elapsed = Date.now() - startTime;
                    data = {
                        title: domain,
                        description: 'ï¼ˆä»… Favicon æ¨¡å¼ï¼Œä¸è°ƒç”¨é¢„è§ˆ APIï¼‰',
                        image: '',
                        favicon: apiUrl,
                        domain: domain,
                    };
                    showStatus('success', `âœ… Favicon æ¨¡å¼ | è€—æ—¶ ${elapsed}ms | æ—  CORS é—®é¢˜`);
                    showRawJson({ mode: 'favicon_only', favicon_url: apiUrl, domain });
                }

                // æ¸²æŸ“é¢„è§ˆå¡ç‰‡
                if (data) {
                    renderPreview(data);
                }

            } catch (err) {
                const elapsed = Date.now() - startTime;
                showStatus('error', `âŒ è¯·æ±‚å¤±è´¥ï¼è€—æ—¶ ${elapsed}ms\né”™è¯¯ï¼š${err.message}\n\nå¯èƒ½åŸå› ï¼šCORS è·¨åŸŸè¢«æ‹’ç»ã€ç½‘ç»œè¶…æ—¶ã€API ä¸å¯ç”¨`);
                showRawJson({ error: err.message, type: err.name, tip: 'è¯·æ‰“å¼€ F12 æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯' });
                console.error('é“¾æ¥é¢„è§ˆè¯·æ±‚å¤±è´¥ï¼š', err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'è·å–é¢„è§ˆ';
            }
        }

        // ==========================================
        // æ¸²æŸ“é¢„è§ˆå¡ç‰‡
        // ==========================================
        function renderPreview(data) {
            const card = document.getElementById('previewCard');

            // Favicon
            const faviconEl = document.getElementById('previewFavicon');
            const fallbackEl = document.getElementById('faviconFallback');
            if (data.favicon) {
                faviconEl.src = data.favicon;
                faviconEl.style.display = 'block';
                fallbackEl.style.display = 'none';
            } else {
                faviconEl.style.display = 'none';
                fallbackEl.textContent = (data.domain || '?')[0].toUpperCase();
                fallbackEl.style.display = 'flex';
            }

            // åŸŸå
            document.getElementById('previewDomain').textContent = data.domain || '';

            // æ ‡é¢˜
            document.getElementById('previewTitle').textContent = data.title || 'ï¼ˆæ— æ ‡é¢˜ï¼‰';

            // æè¿°
            document.getElementById('previewDescription').textContent = data.description || 'ï¼ˆæ— æè¿°ï¼‰';

            // å›¾ç‰‡
            const imgEl = document.getElementById('previewImage');
            if (data.image) {
                imgEl.src = data.image;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            card.style.display = 'block';
        }

        // ==========================================
        // æ˜¾ç¤ºåŸå§‹ JSON
        // ==========================================
        function showRawJson(data) {
            const raw = document.getElementById('rawJson');
            const btn = document.getElementById('toggleJsonBtn');
            raw.textContent = JSON.stringify(data, null, 2);
            raw.style.display = 'none'; // é»˜è®¤æŠ˜å 
            btn.style.display = 'inline-block';
            btn.textContent = 'â–¶ æŸ¥çœ‹åŸå§‹ JSON æ•°æ®';
        }

        // ==========================================
        // æ˜¾ç¤ºè¯·æ±‚ä¿¡æ¯
        // ==========================================
        function showRequestInfo(method, url) {
            const el = document.getElementById('requestInfo');
            el.textContent = `${method} ${url}`;
            el.style.display = 'block';
        }

        // ==========================================
        // è·å– Google Favicon URL
        // ==========================================
        function getFavicon(url) {
            try {
                const domain = new URL(url).hostname;
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
            } catch {
                return '';
            }
        }

        // ==========================================
        // å›è½¦é”®è§¦å‘
        // ==========================================
        document.getElementById('urlInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') fetchPreview();
        });
    </script>
</body>
</html>
